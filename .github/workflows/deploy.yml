name: Deploy to GCP

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: europe-west1
  GCP_ZONE: europe-west1-b
  VM_NAME: meine-app-vm
  DOCKER_IMAGE: europe-west1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/meine-app/app

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Configure Docker
        run: gcloud auth configure-docker europe-west1-docker.pkg.dev
      
      - name: Build Docker Image
        run: |
          docker build -t ${{ env.DOCKER_IMAGE }}:${{ github.sha }} \
                       -t ${{ env.DOCKER_IMAGE }}:latest .
      
      - name: Push Docker Image
        run: |
          docker push ${{ env.DOCKER_IMAGE }}:${{ github.sha }}
          docker push ${{ env.DOCKER_IMAGE }}:latest
      
      - name: Deploy to VM
        run: |
          gcloud compute instances update-container ${{ env.VM_NAME }} \
            --zone=${{ env.GCP_ZONE }} \
            --container-image=${{ env.DOCKER_IMAGE }}:${{ github.sha }} \
            --container-env="PORT=8080,SECRET_KEY=${{ secrets.SECRET_KEY }}" \
            --container-restart-policy=always
      
      - name: Health Check
        run: |
          IP=$(gcloud compute instances describe ${{ env.VM_NAME }} \
            --zone=${{ env.GCP_ZONE }} \
            --format='get(networkInterfaces[0].accessConfigs[0].natIP)')
          
          for i in {1..10}; do
            if curl -f http://${IP}:8080/api/health; then
              echo "âœ… Deployment successful!"
              exit 0
            fi
            sleep 10
          done
          exit 1